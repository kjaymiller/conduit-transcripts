{% extends "layout.html" %}

{% block title %}Search - Conduit Transcripts{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 900px;
        margin: 0 auto;
    }

    form {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    input[type="text"] {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 1.1rem;
        min-width: 200px;
    }

    button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        font-weight: 500;
    }

    button:hover {
        background-color: var(--primary-hover);
    }

    .options {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        width: 100%;
        margin-top: -0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .episode-group {
        margin-bottom: 2rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        background: var(--card-bg);
    }

    .episode-header {
        background: #f1f5f9;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .episode-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text);
        text-decoration: none;
    }
    
    .episode-title:hover {
        color: var(--primary);
    }

    .result-item {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .result-item:last-child {
        border-bottom: none;
    }

    .result-content {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        font-size: 0.9rem;
        color: var(--text);
    }

    .score {
        display: inline-block;
        background: #dcfce7;
        color: #166534;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <h1>Search Transcripts</h1>

    <div class="card">
        <form id="searchForm">
            <input type="text" id="query" placeholder="Search transcripts..." required autofocus>
            <button type="submit">Search</button>
            
            <div class="options">
                <label>
                    <input type="radio" name="type" value="vector" checked> Vector Search
                </label>
                <label>
                    <input type="radio" name="type" value="text"> Text Match
                </label>
                <label>
                    <input type="radio" name="type" value="title"> Title Search
                </label>
            </div>
        </form>
    </div>

    <div id="results" style="display: none;">
        <!-- Results will appear here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('query').value;
        const type = document.querySelector('input[name="type"]:checked').value;
        const resultsDiv = document.getElementById('results');
        
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Searching...</div>';
        
        try {
            const endpoint = `/search/${type}`;
            // Increase limit to get more results for grouping
            const url = `${endpoint}?query=${encodeURIComponent(query)}&limit=50`;
            
            const res = await fetch(url);
            if (!res.ok) throw new Error('Search failed');
            
            const data = await res.json();
            const results = data.results;
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No results found.</div>';
                return;
            }

            // Group by episode
            const groups = {};
            results.forEach(r => {
                const epNum = r.episode_number || r.metadata?.episode_number || 0;
                if (!groups[epNum]) {
                    groups[epNum] = {
                        episode: epNum,
                        title: r.title || r.metadata?.title || `Episode ${epNum}`,
                        url: r.url || r.metadata?.url || '#',
                        matches: []
                    };
                }
                groups[epNum].matches.push(r);
            });

            // Sort groups by episode number descending
            const sortedGroups = Object.values(groups).sort((a, b) => b.episode - a.episode);
            
            let html = `<h3 style="margin-bottom: 1rem;">Found matches in ${sortedGroups.length} episodes</h3>`;
            
            sortedGroups.forEach(group => {
                html += `
                    <div class="episode-group">
                        <div class="episode-header">
                            <div style="flex: 1;">
                                <a href="/episode/${group.episode}" class="episode-title">
                                    Episode ${group.episode}: ${group.title}
                                </a>
                                ${group.url && group.url !== '#' ? `
                                <a href="${group.url}" target="_blank" style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.5rem; text-decoration: none;">
                                    â†—
                                </a>
                                ` : ''}
                            </div>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${group.matches.length} match${group.matches.length === 1 ? '' : 'es'}
                            </span>
                        </div>
                `;
                
                group.matches.forEach(r => {
                    const content = r.content_snippet || r.content || '';
                    const score = r.similarity_score ? `<span class="score">Match: ${(r.similarity_score * 100).toFixed(1)}%</span>` : '';
                    
                    html += `
                        <div class="result-item">
                            <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                                <span style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">MATCH DETAILS</span>
                                ${score}
                            </div>
                            <div class="result-content">${content}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            resultsDiv.innerHTML = html;
            
        } catch (e) {
            resultsDiv.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 2rem;">Error: ${e.message}</div>`;
        }
    });
</script>
{% endblock %}
